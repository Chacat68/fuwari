---
// é¢„åŠ è½½æ€§èƒ½ç›‘æ§ç»„ä»¶
// ç”¨äºç›‘æ§å’Œè°ƒè¯•æ™ºèƒ½é¢„åŠ è½½çš„æ€§èƒ½è¡¨ç°
---

<script>
class PreloadPerformanceMonitor {
  private metrics = {
    preloadCount: 0,
    successfulPreloads: 0,
    failedPreloads: 0,
    averagePreloadTime: 0,
    totalPreloadTime: 0,
    cacheHits: 0,
    networkRequests: 0
  };

  private startTimes = new Map<string, number>();

  constructor() {
    this.init();
  }

  private init() {
    // ç›‘å¬é¢„åŠ è½½äº‹ä»¶
    this.setupEventListeners();
    
    // å®šæœŸè¾“å‡ºæ€§èƒ½æŠ¥å‘Š
    this.setupPerformanceReporting();
  }

  private setupEventListeners() {
    // ç›‘å¬ fetch è¯·æ±‚
    const originalFetch = window.fetch;
    window.fetch = async (...args) => {
      const url = args[0] as string;
      
      if (typeof url === 'string' && this.isPreloadRequest(url)) {
        this.metrics.networkRequests++;
        this.startTimes.set(url, performance.now());
      }
      
      try {
        const response = await originalFetch(...args);
        
        if (typeof url === 'string' && this.isPreloadRequest(url)) {
          this.recordPreloadSuccess(url);
        }
        
        return response;
      } catch (error) {
        if (typeof url === 'string' && this.isPreloadRequest(url)) {
          this.recordPreloadFailure(url);
        }
        throw error;
      }
    };
  }

  private isPreloadRequest(url: string): boolean {
    // æ£€æŸ¥æ˜¯å¦æ˜¯é¢„åŠ è½½è¯·æ±‚
    return url.startsWith('/') && !url.includes('_astro') && !url.includes('pagefind');
  }

  private recordPreloadSuccess(url: string) {
    const startTime = this.startTimes.get(url);
    if (startTime) {
      const duration = performance.now() - startTime;
      this.metrics.successfulPreloads++;
      this.metrics.totalPreloadTime += duration;
      this.metrics.averagePreloadTime = this.metrics.totalPreloadTime / this.metrics.successfulPreloads;
      this.startTimes.delete(url);
    }
  }

  private recordPreloadFailure(url: string) {
    this.metrics.failedPreloads++;
    this.startTimes.delete(url);
  }

  private setupPerformanceReporting() {
    // æ¯30ç§’è¾“å‡ºä¸€æ¬¡æ€§èƒ½æŠ¥å‘Š
    setInterval(() => {
      this.logPerformanceReport();
    }, 30000);

    // é¡µé¢å¸è½½æ—¶è¾“å‡ºæœ€ç»ˆæŠ¥å‘Š
    window.addEventListener('beforeunload', () => {
      this.logPerformanceReport();
    });
  }

  private logPerformanceReport() {
    const report = {
      timestamp: new Date().toISOString(),
      metrics: { ...this.metrics },
      performance: {
        memoryUsage: (performance as any).memory ? {
          used: Math.round((performance as any).memory.usedJSHeapSize / 1024 / 1024),
          total: Math.round((performance as any).memory.totalJSHeapSize / 1024 / 1024),
          limit: Math.round((performance as any).memory.jsHeapSizeLimit / 1024 / 1024)
        } : null,
        navigationTiming: this.getNavigationTiming()
      }
    };

    console.group('ğŸš€ æ™ºèƒ½é¢„åŠ è½½æ€§èƒ½æŠ¥å‘Š');
    console.log('ğŸ“Š é¢„åŠ è½½ç»Ÿè®¡:', report.metrics);
    console.log('ğŸ’¾ å†…å­˜ä½¿ç”¨:', report.performance.memoryUsage);
    console.log('â±ï¸ å¯¼èˆªæ—¶é—´:', report.performance.navigationTiming);
    console.groupEnd();

    // å‘é€åˆ°åˆ†ææœåŠ¡ï¼ˆå¯é€‰ï¼‰
    this.sendToAnalytics(report);
  }

  private getNavigationTiming() {
    const timing = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming;
    if (!timing) return null;

    return {
      domContentLoaded: Math.round(timing.domContentLoadedEventEnd - timing.domContentLoadedEventStart),
      loadComplete: Math.round(timing.loadEventEnd - timing.loadEventStart),
      firstPaint: this.getFirstPaint(),
      firstContentfulPaint: this.getFirstContentfulPaint()
    };
  }

  private getFirstPaint(): number | null {
    const paintEntries = performance.getEntriesByType('paint');
    const fpEntry = paintEntries.find(entry => entry.name === 'first-paint');
    return fpEntry ? Math.round(fpEntry.startTime) : null;
  }

  private getFirstContentfulPaint(): number | null {
    const paintEntries = performance.getEntriesByType('paint');
    const fcpEntry = paintEntries.find(entry => entry.name === 'first-contentful-paint');
    return fcpEntry ? Math.round(fcpEntry.startTime) : null;
  }

  private sendToAnalytics(report: any) {
    // è¿™é‡Œå¯ä»¥é›†æˆ Google Analyticsã€Umami æˆ–å…¶ä»–åˆ†ææœåŠ¡
    if (typeof window !== 'undefined' && (window as any).gtag) {
      (window as any).gtag('event', 'preload_performance', {
        custom_parameter_1: report.metrics.successfulPreloads,
        custom_parameter_2: report.metrics.averagePreloadTime,
        custom_parameter_3: report.metrics.cacheHits
      });
    }
  }

  // å…¬å…±æ–¹æ³•ï¼šè·å–å½“å‰æŒ‡æ ‡
  public getMetrics() {
    return { ...this.metrics };
  }

  // å…¬å…±æ–¹æ³•ï¼šé‡ç½®æŒ‡æ ‡
  public resetMetrics() {
    this.metrics = {
      preloadCount: 0,
      successfulPreloads: 0,
      failedPreloads: 0,
      averagePreloadTime: 0,
      totalPreloadTime: 0,
      cacheHits: 0,
      networkRequests: 0
    };
    this.startTimes.clear();
  }
}

// åˆå§‹åŒ–æ€§èƒ½ç›‘æ§å™¨
let performanceMonitor: PreloadPerformanceMonitor | null = null;

function initPerformanceMonitor() {
  if (!performanceMonitor) {
    performanceMonitor = new PreloadPerformanceMonitor();
  }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initPerformanceMonitor);
} else {
  initPerformanceMonitor();
}

// å¯¼å‡ºåˆ°å…¨å±€ï¼Œä¾¿äºè°ƒè¯•
(window as any).preloadPerformanceMonitor = performanceMonitor;
</script>

<!-- å¼€å‘ç¯å¢ƒä¸‹çš„æ€§èƒ½ç›‘æ§é¢æ¿ -->
{import.meta.env.DEV && (
<div id="preload-monitor-panel" style="
  position: fixed;
  top: 10px;
  right: 10px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 10px;
  border-radius: 5px;
  font-family: monospace;
  font-size: 12px;
  z-index: 9999;
  max-width: 300px;
  display: none;
">
  <div style="margin-bottom: 5px; font-weight: bold;">ğŸš€ é¢„åŠ è½½ç›‘æ§</div>
  <div id="preload-stats"></div>
  <button onclick="toggleMonitorPanel()" style="
    background: #007acc;
    color: white;
    border: none;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 10px;
    margin-top: 5px;
    cursor: pointer;
  ">å…³é—­</button>
</div>

<script>
function toggleMonitorPanel() {
  const panel = document.getElementById('preload-monitor-panel');
  if (panel) {
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  }
}

function updateMonitorPanel() {
  const panel = document.getElementById('preload-stats');
  if (panel && (window as any).preloadPerformanceMonitor) {
    const metrics = (window as any).preloadPerformanceMonitor.getMetrics();
    panel.innerHTML = `
      <div>æˆåŠŸé¢„åŠ è½½: ${metrics.successfulPreloads}</div>
      <div>å¤±è´¥é¢„åŠ è½½: ${metrics.failedPreloads}</div>
      <div>å¹³å‡æ—¶é—´: ${Math.round(metrics.averagePreloadTime)}ms</div>
      <div>ç½‘ç»œè¯·æ±‚: ${metrics.networkRequests}</div>
    `;
  }
}

// æ¯5ç§’æ›´æ–°ä¸€æ¬¡ç›‘æ§é¢æ¿
setInterval(updateMonitorPanel, 5000);

// æ·»åŠ é”®ç›˜å¿«æ·é”®æ˜¾ç¤º/éšè—ç›‘æ§é¢æ¿
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.shiftKey && e.key === 'P') {
    e.preventDefault();
    toggleMonitorPanel();
  }
});
</script>
)}
