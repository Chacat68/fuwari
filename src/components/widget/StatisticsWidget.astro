---
import { Icon } from "astro-icon/components";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";
import { getSortedPosts } from "../../utils/content-utils";
import WidgetLayout from "./WidgetLayout.astro";

interface Props {
	class?: string;
	style?: string;
}

const className = Astro.props.class;
const style = Astro.props.style;

// 计算网站运行时间
const startDate = new Date("2020-01-01"); // 网站开始运行的日期
const today = new Date();
const runningDays = Math.floor(
	(today.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24),
);

// 计算年、月、日
const years = Math.floor(runningDays / 365);
const months = Math.floor((runningDays % 365) / 30);
const days = runningDays % 30;

// 获取所有文章并计算统计信息
const posts = await getSortedPosts();
const totalPosts = posts.length;

// 计算总字数
let totalWords = 0;
for (const post of posts) {
	const { remarkPluginFrontmatter } = await post.render();
	if (remarkPluginFrontmatter?.words) {
		totalWords += remarkPluginFrontmatter.words;
	}
}

// 格式化数字
const formatNumber = (num: number): string => {
	if (num >= 10000) {
		return `${(Math.floor(num / 1000) / 10).toFixed(1)}w`;
	}
	if (num >= 1000) {
		return `${(Math.floor(num / 100) / 10).toFixed(1)}k`;
	}
	return num.toString();
};

const formattedTotalWords = formatNumber(totalWords);
---

<WidgetLayout name={i18n(I18nKey.statistics)} id="statistics-widget" class={className} style={style}>
    <div class="space-y-3">
        <!-- 运行时间 -->
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded-md bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                    <Icon name="material-symbols:schedule-outline-rounded" class="text-blue-600 dark:text-blue-400 text-sm"></Icon>
                </div>
                <span class="text-sm text-neutral-700 dark:text-neutral-300">{i18n(I18nKey.runningDays)}</span>
            </div>
            <div class="text-sm font-medium text-neutral-900 dark:text-neutral-100">
                {years > 0 && `${years}${i18n(I18nKey.years)}`}
                {months > 0 && `${months}${i18n(I18nKey.months)}`}
                {days > 0 && `${days}${i18n(I18nKey.days)}`}
            </div>
        </div>

        <!-- 文章总数 -->
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded-md bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                    <Icon name="material-symbols:article-outline-rounded" class="text-green-600 dark:text-green-400 text-sm"></Icon>
                </div>
                <span class="text-sm text-neutral-700 dark:text-neutral-300">{i18n(I18nKey.totalPosts)}</span>
            </div>
            <div class="text-sm font-medium text-neutral-900 dark:text-neutral-100">
                {totalPosts}
            </div>
        </div>

        <!-- 总字数 -->
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded-md bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                    <Icon name="material-symbols:edit-outline-rounded" class="text-purple-600 dark:text-purple-400 text-sm"></Icon>
                </div>
                <span class="text-sm text-neutral-700 dark:text-neutral-300">{i18n(I18nKey.totalWords)}</span>
            </div>
            <div class="text-sm font-medium text-neutral-900 dark:text-neutral-100">
                {formattedTotalWords}
            </div>
        </div>
    </div>
</WidgetLayout>
